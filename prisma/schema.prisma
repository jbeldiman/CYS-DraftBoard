generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  BOARD
  COACH
  PARENT
}

enum TradeStatus {
  PENDING
  ACCEPTED
  REJECTED
  COUNTERED
  CANCELLED
}

enum TradeSide {
  FROM_GIVES
  TO_GIVES
}

enum DraftPhase {
  SETUP
  LIVE
  COMPLETE
}

enum AccessRequestType {
  COACH
  BOARD
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  DENIED
}

model User {
  id           String  @id @default(cuid())
  name         String?
  email        String? @unique
  passwordHash String?
  role         Role    @default(PARENT)

  coachOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts     Account[]
  sessions     Session[]
  coachedTeams DraftTeam[] @relation("CoachTeams")

  accessRequests        AccessRequest[]
  decidedAccessRequests AccessRequest[] @relation("AccessRequestDecidedBy")

  createdTrades   Trade[] @relation("TradeCreatedBy")
  respondedTrades Trade[] @relation("TradeRespondedBy")
}

model Trade {
  id           String     @id @default(cuid())
  draftEventId String
  draftEvent   DraftEvent @relation(fields: [draftEventId], references: [id], onDelete: Cascade)

  fromTeamId String
  fromTeam   DraftTeam @relation("TradeFromTeam", fields: [fromTeamId], references: [id], onDelete: Cascade)

  toTeamId String
  toTeam   DraftTeam @relation("TradeToTeam", fields: [toTeamId], references: [id], onDelete: Cascade)

  status TradeStatus @default(PENDING)

  createdByUserId String
  createdByUser   User   @relation("TradeCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)

  respondedByUserId String?
  respondedByUser   User?   @relation("TradeRespondedBy", fields: [respondedByUserId], references: [id], onDelete: SetNull)

  parentTradeId String?
  parentTrade   Trade?  @relation("TradeParent", fields: [parentTradeId], references: [id], onDelete: SetNull)
  counters      Trade[] @relation("TradeParent")

  fromAvgRound Float?
  toAvgRound   Float?
  roundDelta   Float?

  message String?

  executedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  items TradeItem[]

  @@index([draftEventId, status, updatedAt])
  @@index([fromTeamId, status, updatedAt])
  @@index([toTeamId, status, updatedAt])
}

model TradeItem {
  id      String @id @default(cuid())
  tradeId String
  trade   Trade  @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  playerId String
  player   DraftPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)

  side TradeSide

  @@index([tradeId, side])
  @@index([playerId])
}

model AccessRequest {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   AccessRequestType
  status AccessRequestStatus @default(PENDING)

  requestedAt   DateTime  @default(now())
  decidedAt     DateTime?
  decidedById   String?
  decidedBy     User?     @relation("AccessRequestDecidedBy", fields: [decidedById], references: [id], onDelete: SetNull)
  decisionNotes String?

  @@unique([userId, type, status])
  @@index([status, type, requestedAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model DraftEvent {
  id          String     @id @default(cuid())
  name        String
  scheduledAt DateTime
  phase       DraftPhase @default(SETUP)

  currentPick        Int       @default(1)
  pickClockSeconds   Int       @default(120)
  isPaused           Boolean   @default(true)
  clockEndsAt        DateTime?
  pauseRemainingSecs Int?

  teams        DraftTeam[]
  players      DraftPlayer[]
  picks        DraftPick[]
  siblingCosts SiblingDraftCost[]
  trades       Trade[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DraftTeam {
  id           String     @id @default(cuid())
  draftEventId String
  draftEvent   DraftEvent @relation(fields: [draftEventId], references: [id], onDelete: Cascade)

  name  String
  order Int

  coachUserId String?
  coachUser   User?   @relation("CoachTeams", fields: [coachUserId], references: [id], onDelete: SetNull)

  draftedPlayers DraftPlayer[] @relation("TeamDraftedPlayers")
  picks          DraftPick[]

  tradesSent     Trade[] @relation("TradeFromTeam")
  tradesReceived Trade[] @relation("TradeToTeam")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([draftEventId, order])
  @@unique([draftEventId, name])
}

model DraftPlayer {
  id           String     @id @default(cuid())
  draftEventId String
  draftEvent   DraftEvent @relation(fields: [draftEventId], references: [id], onDelete: Cascade)

  registrationId String?   @unique
  firstName      String
  lastName       String
  fullName       String
  gender         String?
  dob            DateTime?
  birthYear      Int?
  leagueChoice   String?
  wantsU13       Boolean   @default(false)

  jerseySize String?

  guardian1Name String?
  guardian2Name String?
  primaryPhone  String?
  primaryEmail  String?

  experience       String?
  fall2025Rating   Int?
  spring2025Rating Int?
  spring2026Rating Int?
  notes            String?
  rank             Int?

  isDraftEligible Boolean @default(false)
  isDrafted       Boolean @default(false)

  draftedTeamId String?
  draftedTeam   DraftTeam? @relation("TeamDraftedPlayers", fields: [draftedTeamId], references: [id], onDelete: SetNull)
  draftedAt     DateTime?

  picks             DraftPick[]
  siblingDraftCosts SiblingDraftCost[]
  tradeItems        TradeItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([draftEventId, isDraftEligible, isDrafted])
  @@index([draftEventId, lastName, firstName])
}

model DraftPick {
  id           String     @id @default(cuid())
  draftEventId String
  draftEvent   DraftEvent @relation(fields: [draftEventId], references: [id], onDelete: Cascade)

  overallNumber Int
  round         Int
  pickInRound   Int

  teamId String
  team   DraftTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  playerId String
  player   DraftPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)

  madeAt DateTime @default(now())

  @@unique([draftEventId, overallNumber])
  @@unique([draftEventId, playerId])
  @@index([draftEventId, teamId])
}

model SiblingDraftCost {
  id String @id @default(cuid())

  draftEventId String
  draftEvent   DraftEvent @relation(fields: [draftEventId], references: [id], onDelete: Cascade)

  playerId String
  player   DraftPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)

  groupKey  String
  draftCost String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([draftEventId, playerId])
  @@index([draftEventId, groupKey])
  @@index([draftEventId])
}
